# Администрирование

## Purpose

Предоставлять админ-эндпоинты для управления пространством имен KV (очистка обработанных постов/записей медиа) и перечисления всех обработанных записей. Требует аутентификации через заголовок x-admin-token.

## Requirements

### Требование: Эндпоинт очистки KV администратора

Система SHALL предоставлять админ-эндпоинт для очистки записей пространства имен KV по префиксу.

#### Сценарий: Очистка всех ключей

- **WHEN** POST-запрос к `/admin/kv/clear?prefix=all`
- **AND** заголовок x-admin-token соответствует TELEGRAM_BOT_TOKEN
- **THEN** система очищает все ключи "post:"
- **AND** очищает все ключи "media:"
- **AND** возвращает JSON с общим количеством удаленных и деталями

#### Сценарий: Очистка по префиксу

- **WHEN** POST-запрос к `/admin/kv/clear?prefix=post:`
- **AND** заголовок x-admin-token соответствует TELEGRAM_BOT_TOKEN
- **THEN** система очищает все ключи, начинающиеся с "post:"
- **AND** возвращает JSON с количеством удаленных и префиксом

#### Сценарий: Очистка префикса медиа

- **WHEN** POST-запрос к `/admin/kv/clear?prefix=media:`
- **AND** заголовок x-admin-token соответствует TELEGRAM_BOT_TOKEN
- **THEN** система очищает все ключи, начинающиеся с "media:"
- **AND** возвращает JSON с количеством удаленных и префиксом

#### Сценарий: Требуется аутентификация

- **WHEN** POST-запрос к `/admin/kv/clear`
- **AND** заголовок x-admin-token не соответствует TELEGRAM_BOT_TOKEN
- **THEN** система возвращает 401 Unauthorized
- **AND** не очищает никакие ключи

#### Сценарий: Метод не разрешен

- **WHEN** запрос к `/admin/kv/clear` использует метод, отличный от POST
- **THEN** система возвращает 405 Method Not Allowed

#### Сценарий: Отсутствует параметр prefix

- **WHEN** POST-запрос к `/admin/kv/clear` без параметра prefix
- **THEN** система возвращает 400 Bad Request
- **AND** сообщение об ошибке перечисляет валидные префиксы: "post:", "media:", "all"

#### Сценарий: Невалидный префикс

- **WHEN** POST-запрос к `/admin/kv/clear?prefix=invalid`
- **AND** префикс не "post:", "media:" или "all"
- **THEN** система возвращает 400 Bad Request

### Требование: Перечисление обработанных постов

Система SHALL предоставлять эндпоинт для перечисления всех обработанных постов из KV.

#### Сценарий: Перечисление всех записей KV

- **WHEN** GET-запрос к корневому пути "/"
- **THEN** система возвращает JSON-массив всех ключей KV через PROCESSED_POSTS_KV.list()
- **AND** включает имена ключей и метаданные

### Требование: Реализация очистки KV по префиксу

Система SHALL эффективно очищать записи пространства имен KV, соответствующие префиксу.

#### Сценарий: Пагинированная очистка

- **WHEN** clearKvPrefix вызывается с префиксом
- **THEN** система перечисляет ключи с префиксом, используя пагинацию курсора
- **AND** удаляет ключи пакетами
- **AND** продолжает до тех пор, пока list_complete не станет true
- **AND** возвращает общее количество удаленных ключей

#### Сценарий: Пустой результат префикса

- **WHEN** префикс не соответствует никаким ключам
- **THEN** система возвращает 0 удаленных
- **AND** завершается без ошибки
