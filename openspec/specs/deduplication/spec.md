# Дедупликация

## Purpose

Предотвращать обработку того же поста Reddit или публикацию того же URL медиа несколько раз, используя хранилище Cloudflare KV с двухуровневой дедупликацией (на уровне постов и на уровне медиа). Резервировать ключи перед дорогостоящими операциями для предотвращения условий гонки.

## Requirements

### Требование: Дедупликация на уровне постов

Система SHALL предотвращать обработку того же поста Reddit несколько раз, используя хранилище KV.

#### Сценарий: Генерация ключа поста

- **WHEN** пост обрабатывается
- **THEN** система генерирует уникальный ключ из данных поста
- **AND** приоритизирует: name (t3\_\*), id, permalink, url или "title::created_utc"
- **AND** нормализует URL, удаляя query и hash
- **AND** добавляет префикс "post:" к ключу

#### Сценарий: Пропуск обработанного поста

- **WHEN** ключ поста существует в KV со значением "0" или "pending"
- **THEN** система пропускает обработку
- **AND** логирует пропуск с ключом и состоянием

#### Сценарий: Отслеживание количества повторов

- **WHEN** ключ поста существует с числовым значением
- **THEN** система интерпретирует значение как оставшиеся повторы
- **AND** использует это количество для логики повторов

#### Сценарий: Пометить пост как обработанный

- **WHEN** пост успешно обработан
- **THEN** система сохраняет ключ со значением "0"
- **AND** устанавливает TTL истечения срока действия на 604800 секунд (7 дней)

#### Сценарий: Дедупликация в рамках одного запуска

- **WHEN** тот же пост появляется несколько раз в одном запуске cron
- **THEN** система отслеживает обработанные ключи в Set
- **AND** пропускает дубликаты в рамках того же запуска

### Требование: Дедупликация на уровне медиа

Система SHALL предотвращать публикацию того же URL медиа несколько раз, используя канонизированные URL.

#### Сценарий: Канонизация URL медиа

- **WHEN** URL медиа извлечен
- **THEN** система канонизирует URL путем:
  - Удаления query-параметров и hash
  - Приведения hostname к нижнему регистру
  - Удаления завершающих слэшей
- **AND** добавляет префикс "media:" к ключу

#### Сценарий: Ранняя дедупликация медиа

- **WHEN** сырой URL медиа извлечен
- **THEN** система проверяет, существует ли канонизированный ключ в KV или текущем запуске
- **AND** если существует, помечает пост как обработанный ("0") и пропускает
- **AND** резервирует оба ключа (поста и медиа) как "pending"

#### Сценарий: Финальная дедупликация медиа

- **WHEN** URL медиа разрешен и может отличаться от сырого URL
- **THEN** система повторно проверяет финальный канонизированный ключ
- **AND** если существует, помечает пост как обработанный и пропускает

#### Сценарий: Перемещение резервации

- **WHEN** ключ сырого медиа отличается от финального разрешенного ключа медиа
- **THEN** система удаляет резервацию сырого ключа
- **AND** создает резервацию с финальным ключом медиа
- **AND** логирует перемещение ключа

#### Сценарий: Медиа уже опубликовано

- **WHEN** ключ медиа существует в KV со значением "1"
- **THEN** система пропускает обработку
- **AND** помечает связанный пост как обработанный

#### Сценарий: Пометить медиа как опубликованное

- **WHEN** медиа успешно опубликовано в Telegram
- **THEN** система сохраняет ключ медиа со значением "1"
- **AND** устанавливает TTL истечения срока действия на 604800 секунд

#### Сценарий: Освобождение резервации при ошибке

- **WHEN** обработка завершается ошибкой
- **THEN** система удаляет резервации обоих ключей (поста и медиа)
- **AND** позволяет повторить попытку при следующем запуске cron

### Требование: Резервирование ключей

Система SHALL резервировать ключи перед дорогостоящими операциями для предотвращения условий гонки.

#### Сценарий: Резервирование ключей как pending

- **WHEN** пост и медиа идентифицированы
- **THEN** система сохраняет оба ключа со значением "pending"
- **AND** устанавливает TTL истечения срока действия на 604800 секунд
- **AND** логирует резервацию

#### Сценарий: Предотвращение параллельных запусков

- **WHEN** другой запуск cron обрабатывает тот же пост
- **AND** ключ существует как "pending"
- **THEN** второй запуск пропускает обработку
- **AND** предотвращает дублирование работы
