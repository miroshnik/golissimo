# Генерация хештегов

## Purpose

Генерировать контекстуальные хештеги (команды, игроки, события) из заголовков постов Reddit, используя Cloudflare Workers AI (Llama 3.1 8B) с промптами на русском языке. Нормализовать хештеги до символов ASCII для совместимости.

## Requirements

### Требование: Генерация хештегов через AI

Система SHALL использовать Cloudflare Workers AI (Llama 3.1 8B) для генерации контекстуальных хештегов из заголовков постов.

#### Сценарий: Генерация хештегов через AI

- **WHEN** заголовок поста извлечен
- **THEN** система отправляет промпт в AI с русскими инструкциями
- **AND** использует модель "@cf/meta/llama-3-8b-instruct"
- **AND** включает системное сообщение: "Ты — краткая система генерации хештегов. Возвращай только хештеги одной строкой."
- **AND** добавляет заголовок поста к промпту

#### Сценарий: Применение правил хештегов

- **WHEN** AI генерирует хештеги
- **THEN** система применяет правила:
  - Только названия команд и игроков
  - Только символы ASCII (ä→a, ö→o, é→e и т.д.)
  - Один тег события: #Goal, #Assist, #Save, #RedCard, #YellowCard, #Penalty, #PenaltyMiss, #OwnGoal, #Injury, #Transfer, #Interview, #Statistics
  - Порядок: команды → игроки → событие
  - Нет #Goal без явных индикаторов гола

#### Сценарий: Нормализация хештегов

- **WHEN** AI возвращает хештеги
- **THEN** система:
  - Удаляет точки из тегов
  - Схлопывает множественные пробелы
  - Обеспечивает, что все теги начинаются с "#"
  - Удаляет не-алфавитно-цифровые символы из тела тега (сохраняет префикс #)
  - Объединяет теги пробелами

#### Сценарий: Обработка пустых хештегов

- **WHEN** AI возвращает пустой или невалидный ответ
- **THEN** система устанавливает хештеги в пустую строку
- **AND** продолжает обработку без хештегов

#### Сценарий: Логирование хештегов

- **WHEN** хештеги успешно сгенерированы
- **THEN** система логирует "ai:ok" с ключом поста
- **AND** включает хештеги в сообщение Telegram на новой строке

### Требование: Построение промпта хештегов

Система SHALL конструировать детальные промпты на русском языке для генерации хештегов через AI.

#### Сценарий: Промпт включает примеры

- **WHEN** промпт конструируется
- **THEN** система включает примеры:
  - Пример гола: "Annecy 1-0 Caen - Yohann Demoncy 13'" → "#Annecy #Caen #YohannDemoncy #Goal"
  - Пример интервью: "Bernardo Silva: 'We must improve'" → "#BernardoSilva #Interview"
  - Пример статистики: "Top 10 goalscorers in La Liga" → "#LaLiga #Statistics"

#### Сценарий: Промпт включает правила

- **WHEN** промпт конструируется
- **THEN** система включает правила о:
  - Нормализации символов (диакритики)
  - Критериях выбора тега события
  - Когда использовать #Interview vs #Statistics
  - Порядке тегов (команды → игроки → событие)
