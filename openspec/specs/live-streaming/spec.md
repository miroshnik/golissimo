# Лайв-стриминг

## Purpose

Предоставлять CLI-утилиту для трансляции видео-стримов с веб-страниц плееров в Telegram через RTMP/RTMPS, используя Puppeteer для извлечения URL стрима и FFmpeg для перекодирования и передачи.

## Requirements

### Требование: Проверка наличия FFmpeg

Система SHALL проверять наличие FFmpeg перед началом стриминга.

#### Сценарий: FFmpeg установлен

- **WHEN** запускается команда стриминга
- **THEN** система проверяет наличие FFmpeg через `ffmpeg -version`
- **AND** продолжает выполнение, если FFmpeg найден

#### Сценарий: FFmpeg не установлен

- **WHEN** FFmpeg не найден в системе
- **THEN** система выводит инструкции по установке
- **AND** завершает выполнение с кодом ошибки 1

### Требование: Извлечение URL стрима через Puppeteer

Система SHALL использовать Puppeteer для извлечения URL стрима с веб-страницы плеера.

#### Сценарий: Загрузка страницы плеера

- **WHEN** предоставлен URL страницы плеера
- **THEN** система запускает Puppeteer в headless режиме
- **AND** открывает страницу по URL
- **AND** устанавливает User-Agent для имитации браузера
- **AND** ждет загрузки DOM

#### Сценарий: Перехват сетевых запросов

- **WHEN** страница загружается
- **THEN** система перехватывает все сетевые ответы
- **AND** ищет URL, содержащие `.m3u8` (HLS манифесты)
- **AND** ищет URL, содержащие `.mp4`
- **AND** ищет URL, содержащие `.ts` (HLS сегменты) для определения базового пути M3U8

#### Сценарий: Обнаружение M3U8 стрима

- **WHEN** найден URL с `.m3u8`
- **THEN** система добавляет URL в список найденных URL
- **AND** логирует обнаружение M3U8

#### Сценарий: Обнаружение MP4 стрима

- **WHEN** найден URL с `.mp4` и без "ads" в пути
- **THEN** система добавляет URL в список найденных URL
- **AND** логирует обнаружение MP4

#### Сценарий: Определение M3U8 из TS сегментов

- **WHEN** найден URL с `.ts` (не M3U8, не ads, не .cts)
- **THEN** система конструирует M3U8 URL как базовый путь + `/index.m3u8`
- **AND** добавляет сконструированный URL, если его еще нет в списке

#### Сценарий: Клики для запуска видео

- **WHEN** страница загружена
- **THEN** система ждет 5 секунд для загрузки плеера
- **AND** выполняет до 3 кликов мыши в центре экрана (640, 360)
- **AND** ждет 2 секунды между кликами

#### Сценарий: Мониторинг сети

- **WHEN** выполнены клики запуска
- **THEN** система ждет 20 секунд для мониторинга сетевых запросов
- **AND** продолжает перехватывать URL стримов

#### Сценарий: Фильтрация blob URL

- **WHEN** найдены URL стримов
- **THEN** система фильтрует URL, начинающиеся с "blob:"
- **AND** оставляет только валидные HTTP/HTTPS URL

#### Сценарий: Выбор URL стрима

- **WHEN** найдено несколько URL
- **THEN** система приоритезирует M3U8 URL без "/url\_" в пути
- **AND** использует первый найденный валидный URL, если M3U8 нет

#### Сценарий: Извлечение cookies

- **WHEN** URL стрима найден
- **THEN** система получает все cookies с страницы
- **AND** конвертирует их в строку формата "name=value; name2=value2"
- **AND** возвращает URL и cookies вместе

#### Сценарий: Закрытие браузера

- **WHEN** URL извлечен или ошибка произошла
- **THEN** система закрывает браузер Puppeteer
- **AND** освобождает ресурсы

#### Сценарий: URL не найден

- **WHEN** валидные URL стримов не найдены
- **THEN** система возвращает null
- **AND** выводит сообщение об ошибке
- **AND** закрывает браузер

### Требование: Трансляция через FFmpeg

Система SHALL использовать FFmpeg для трансляции стрима в Telegram через RTMP/RTMPS.

#### Сценарий: Проверка переменных окружения

- **WHEN** запускается трансляция
- **THEN** система проверяет наличие TELEGRAM_RTMPS_URL и TELEGRAM_STREAM_KEY
- **AND** завершает выполнение с ошибкой, если переменные не установлены

#### Сценарий: Конвертация RTMPS в RTMP

- **WHEN** TELEGRAM_RTMPS_URL начинается с "rtmps://"
- **THEN** система конвертирует в "rtmp://" для лучшей совместимости
- **AND** логирует предупреждение о конвертации

#### Сценарий: Построение полного RTMP URL

- **WHEN** URL RTMP и ключ стрима доступны
- **THEN** система конкатенирует URL и ключ
- **AND** использует полный URL для FFmpeg вывода

#### Сценарий: Добавление HTTP заголовков

- **WHEN** предоставлен referer (URL страницы плеера)
- **THEN** система конструирует заголовки:
  - Referer: URL страницы плеера
  - Origin: origin из URL страницы
  - User-Agent: Mozilla/5.0...
  - Cookie: строка cookies (если предоставлена)
- **AND** передает заголовки в FFmpeg через `-headers`

#### Сценарий: Настройка FFmpeg для входа

- **WHEN** FFmpeg запускается
- **THEN** система настраивает вход:
  - `-re` для чтения в нативной частоте кадров (до флага `-i`)
  - `-rtbufsize 100M` для буферизации входа
  - `-probesize 10M` и `-analyzeduration 10M` для анализа потока
  - `-i` с URL стрима входа

#### Сценарий: Настройка FFmpeg для выхода

- **WHEN** FFmpeg запускается
- **THEN** система настраивает выход:
  - `-c:v copy` для копирования видеопотока без перекодирования
  - `-c:a aac` для перекодирования аудио в AAC
  - `-b:a 128k` для битрейта аудио
  - `-ac 2` для стерео звука
  - `-ar 44100` для частоты дискретизации
  - `-bufsize 3000k` и `-maxrate 3000k` для буферизации выхода
  - `-f flv` для формата выхода
  - RTMP URL назначения

#### Сценарий: Перехват вывода FFmpeg

- **WHEN** FFmpeg запущен
- **THEN** система перехватывает stdout и stderr
- **AND** выводит данные в консоль

#### Сценарий: Обработка завершения FFmpeg

- **WHEN** процесс FFmpeg завершается
- **THEN** система логирует код выхода
- **AND** завершает процесс с тем же кодом

#### Сценарий: Обработка ошибок FFmpeg

- **WHEN** FFmpeg встречает ошибку
- **THEN** система логирует ошибку
- **AND** завершает процесс с кодом 1

#### Сценарий: Обработка Ctrl+C

- **WHEN** пользователь нажимает Ctrl+C
- **THEN** система логирует сообщение об остановке
- **AND** отправляет SIGTERM процессу FFmpeg
- **AND** через 5 секунд отправляет SIGKILL, если процесс еще запущен
- **AND** завершает с кодом 0

### Требование: CLI интерфейс

Система SHALL предоставлять CLI интерфейс для запуска стриминга.

#### Сценарий: Показ помощи

- **WHEN** команда запущена без аргументов или с "help"
- **THEN** система выводит использование:
  - `npm run stream:start <player_url>`
  - Примеры URL плееров
- **AND** завершает с кодом 0

#### Сценарий: Команда start без URL

- **WHEN** команда "start" вызвана без URL
- **THEN** система выводит ошибку с указанием необходимости URL
- **AND** показывает использование и примеры
- **AND** завершает с кодом 1

#### Сценарий: Валидация URL

- **WHEN** URL предоставлен
- **THEN** система проверяет, что URL начинается с "http://" или "https://"
- **AND** завершает с ошибкой, если URL невалиден

#### Сценарий: Успешный запуск стрима

- **WHEN** валидный URL предоставлен
- **AND** FFmpeg установлен
- **AND** URL стрима успешно извлечен
- **THEN** система запускает трансляцию через FFmpeg
- **AND** стрим передается в Telegram

#### Сценарий: Неизвестная команда

- **WHEN** команда не "start" и не "help"
- **THEN** система выводит ошибку "Unknown command"
- **AND** показывает использование
- **AND** завершает с кодом 1

#### Сценарий: Обработка ошибок

- **WHEN** происходит ошибка при извлечении URL или запуске стрима
- **THEN** система логирует ошибку
- **AND** завершает с кодом ошибки

### Требование: Передача cookies и referer

Система SHALL передавать cookies и referer в FFmpeg для доступа к защищенным стримам.

#### Сценарий: Передача referer

- **WHEN** URL страницы плеера предоставлен
- **THEN** система включает referer в HTTP заголовки FFmpeg
- **AND** использует referer для имитации запроса с той же страницы

#### Сценарий: Передача cookies

- **WHEN** cookies извлечены из браузера
- **THEN** система включает cookies в HTTP заголовки FFmpeg
- **AND** использует cookies для аутентификации доступа к стриму

#### Сценарий: Отсутствие referer и cookies

- **WHEN** referer и cookies не предоставлены
- **THEN** система использует только User-Agent в заголовках
- **AND** продолжает выполнение
