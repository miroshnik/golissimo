# Извлечение медиа

## Purpose

Извлекать URL-адреса медиа (видео, изображения) из метаданных постов Reddit, приоритезируя полные форматы (MP4 с аудио) над частичными форматами (DASH, HLS). Извлекать метаданные видео и миниатюры для публикации в Telegram.

## Requirements

### Требование: Извлечение наилучшего URL медиа

Система SHALL извлекать наилучший доступный URL медиа из метаданных поста Reddit, приоритезируя полные медиа над частичными форматами.

#### Сценарий: Нативное видео Reddit с fallback

- **WHEN** пост содержит `media.reddit_video.fallback_url` (MP4)
- **THEN** система использует fallback_url как URL видео
- **AND** помечает mediaKind как 'mp4_fallback'

#### Сценарий: Нативное видео Reddit с scraper URL

- **WHEN** пост содержит `media.reddit_video.scraper_media_url` (MP4)
- **AND** fallback_url недоступен
- **THEN** система использует scraper_media_url как URL видео
- **AND** помечает mediaKind как 'mp4_scraper'

#### Сценарий: Видео Reddit HLS

- **WHEN** пост содержит только `media.reddit_video.hls_url`
- **AND** MP4 fallback недоступен
- **THEN** система использует hls_url как URL видео
- **AND** помечает mediaKind как 'direct'

#### Сценарий: Вариант предпросмотра MP4

- **WHEN** пост имеет `preview.images[0].variants.mp4.source.url`
- **AND** нативное видео Reddit недоступно
- **THEN** система использует URL варианта MP4
- **AND** декодирует кодировку URL Reddit (&amp; → &)

#### Сценарий: Вариант предпросмотра GIF

- **WHEN** пост имеет `preview.images[0].variants.gif.source.url`
- **AND** вариант MP4 недоступен
- **THEN** система использует URL варианта GIF

#### Сценарий: Пост-галерея

- **WHEN** пост является галереей (`is_gallery: true`)
- **THEN** система извлекает первое изображение из `gallery_data.items`
- **AND** использует `media_metadata[item.media_id].s.u` (оригинал) или самое большое превью

#### Сценарий: Прямое изображение предпросмотра

- **WHEN** пост имеет `preview.images[0].source.url`
- **AND** варианты или галерея недоступны
- **THEN** система использует URL источника предпросмотра

#### Сценарий: Прямой URL медиа

- **WHEN** пост имеет `url_overridden_by_dest` или прямой URL
- **AND** URL соответствует паттерну `\.(jpe?g|png|gif|mp4|m3u8)(\?|$)`
- **THEN** система использует этот URL напрямую

### Требование: Извлечение метаданных видео

Система SHALL извлекать размеры и длительность видео из данных поста Reddit при их наличии.

#### Сценарий: Извлечение метаданных видео

- **WHEN** пост содержит `media.reddit_video`
- **THEN** система извлекает width, height и duration
- **AND** сохраняет значения для метаданных API Telegram

#### Сценарий: Отсутствие метаданных

- **WHEN** пост не содержит метаданных видео
- **THEN** система устанавливает width, height и duration в null

### Требование: Извлечение миниатюры

Система SHALL извлекать наилучшую доступную миниатюру/изображение предпросмотра для генерации превью Telegram.

#### Сценарий: Миниатюра галереи

- **WHEN** пост является галереей
- **THEN** система использует `media_metadata[item.media_id].s.u` или самое большое превью

#### Сценарий: Миниатюра изображения предпросмотра

- **WHEN** пост имеет `preview.images[0]`
- **THEN** система использует `source.url` или самое большое разрешение в массиве `resolutions`

#### Сценарий: Прямой URL изображения как миниатюра

- **WHEN** пост имеет `url_overridden_by_dest`, соответствующий паттерну изображения
- **THEN** система использует этот URL как миниатюру

### Требование: Обработка формата видео DASH

Система SHALL обнаруживать и обрабатывать формат видео DASH Reddit (только видео, отдельная аудиодорожка).

#### Сценарий: Обнаружение видео DASH

- **WHEN** URL видео содержит "DASH\_" и заканчивается на ".mp4"
- **AND** MP4 fallback недоступен
- **THEN** система помечает mediaKind как 'dash'
- **AND** конструирует URL аудио, заменяя видеодорожку на "DASH_audio.mp4"
- **AND** логирует предупреждение о видео только с DASH

#### Сценарий: DASH с fallback

- **WHEN** URL видео в формате DASH
- **AND** MP4 fallback_url или scraper_media_url существует
- **THEN** система использует полный MP4 вместо этого
- **AND** пропускает обработку DASH
