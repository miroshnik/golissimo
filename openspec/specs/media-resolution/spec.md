# Разрешение URL медиа

## Purpose

Разрешать HTML-страницы и извлекать реальные URL видео с помощью автоматизации браузера Puppeteer. Определять доверенные источники, которые предоставляют прямые URL медиа без необходимости разрешения.

## Requirements

### Требование: Разрешение URL медиа через Puppeteer

Система SHALL использовать автоматизацию браузера Puppeteer для разрешения HTML-страниц и извлечения реальных URL видео.

#### Сценарий: Разрешение URL не-MP4

- **WHEN** URL медиа не заканчивается на .mp4
- **AND** URL не из доверенного источника (v.redd.it, reddit.com, googlevideo.com)
- **THEN** система запускает браузер Puppeteer
- **AND** переходит по URL
- **AND** перехватывает сетевые запросы/ответы для поиска URL MP4
- **AND** возвращает первый найденный валидный URL MP4
- **AND** закрывает браузер в течение 3 секунд

#### Сценарий: Валидация URL MP4 из ненадежного источника

- **WHEN** URL заканчивается на .mp4
- **AND** URL не из доверенного источника
- **AND** валидация URL не проходит (возвращает HTML)
- **THEN** система разрешает URL через Puppeteer
- **AND** обновляет URL видео, если разрешенный URL отличается

#### Сценарий: Перехват запросов

- **WHEN** Puppeteer переходит по URL
- **THEN** система перехватывает все сетевые запросы
- **AND** проверяет, соответствует ли URL запроса паттерну MP4
- **AND** захватывает первый найденный URL MP4

#### Сценарий: Перехват ответов

- **WHEN** Puppeteer переходит по URL
- **THEN** система перехватывает все сетевые ответы
- **AND** проверяет, соответствует ли URL ответа паттерну MP4
- **AND** захватывает первый найденный URL MP4

#### Сценарий: Ожидание запроса

- **WHEN** URL MP4 не найден во время загрузки страницы
- **THEN** система ожидает до 5 секунд запрос MP4
- **AND** захватывает URL при обнаружении

#### Сценарий: Резервный вариант — парсинг DOM

- **WHEN** URL MP4 не найден через перехват сети
- **THEN** система запрашивает DOM для элементов `<video>` и `<source>`
- **AND** извлекает атрибуты src
- **AND** возвращает первый найденный URL MP4

#### Сценарий: Резервный вариант — записи производительности

- **WHEN** URL MP4 не найден через сеть или DOM
- **THEN** система сканирует записи производительности для URL ресурсов
- **AND** возвращает первый найденный URL MP4

#### Сценарий: Оптимизация раннего возврата

- **WHEN** URL MP4 найден во время перехвата загрузки страницы
- **THEN** система возвращается немедленно без ожидания завершения страницы
- **AND** быстро закрывает браузер

#### Сценарий: Таймаут закрытия браузера

- **WHEN** вызов browser.close() занимает дольше 3 секунд
- **THEN** система отклоняет с ошибкой таймаута
- **AND** подавляет ошибки WebSocket во время закрытия

#### Сценарий: Обработка ошибок

- **WHEN** Puppeteer встречает ошибку
- **AND** URL MP4 уже был найден
- **THEN** система возвращает найденный URL
- **AND** логирует ошибку без выбрасывания исключения

#### Сценарий: URL не найден

- **WHEN** Puppeteer завершает все попытки разрешения
- **AND** URL MP4 не найден
- **THEN** система возвращает null
- **AND** логирует неудачу разрешения

### Требование: Определение URL MP4

Система SHALL корректно определять URL-адреса, указывающие на файлы видео MP4.

#### Сценарий: Прямой URL MP4

- **WHEN** URL содержит ".mp4" и не содержит "DASH_96."
- **THEN** система определяет как URL MP4

#### Сценарий: URL YouTube videoplayback

- **WHEN** URL содержит "googlevideo.com/videoplayback"
- **THEN** система определяет как URL видео

#### Сценарий: Паттерн CDN видео

- **WHEN** URL содержит "/video" и ("mime=video" или "contenttype=video")
- **THEN** система определяет как URL видео

### Требование: Определение доверенных источников

Система SHALL пропускать разрешение URL для доверенных источников, которые предоставляют прямые URL медиа.

#### Сценарий: Доверенный источник Reddit

- **WHEN** URL включает "v.redd.it" или "reddit.com"
- **THEN** система пропускает разрешение Puppeteer
- **AND** использует URL напрямую

#### Сценарий: Доверенный источник Google Video

- **WHEN** URL включает "googlevideo.com"
- **THEN** система пропускает разрешение Puppeteer
- **AND** валидирует URL вместо этого

#### Сценарий: Ненадежный источник

- **WHEN** URL не из доверенного источника
- **THEN** система валидирует или разрешает URL перед использованием
