# Валидация медиа

## Purpose

Валидировать, что URL видео действительно указывают на файлы видео (а не HTML-страницы) перед отправкой в Telegram. Определять прямые URL изображений, которые могут быть отправлены через API sendPhoto.

## Requirements

### Требование: Валидация URL видео

Система SHALL валидировать, что URL видео действительно указывают на файлы видео перед отправкой в Telegram.

#### Сценарий: Пропуск валидации для доверенного домена

- **WHEN** URL включает "v.redd.it", "reddit.com" или "streamain.com"
- **THEN** система пропускает валидацию
- **AND** автоматически помечает URL как валидный

#### Сценарий: Валидация запросом HEAD

- **WHEN** URL требует валидации
- **THEN** система отправляет запрос HEAD с User-Agent похожим на Telegram
- **AND** проверяет заголовок Content-Type
- **AND** следует редиректам

#### Сценарий: Отклонение HTML-страниц

- **WHEN** Content-Type ответа HEAD включает "text/html" или "text/plain"
- **THEN** система помечает URL как невалидный
- **AND** логирует обнаружение HTML-страницы

#### Сценарий: Проверка Content-Type

- **WHEN** Content-Type ответа HEAD включает "video/" или "application/octet-stream"
- **THEN** система загружает первые 1KB через GET с заголовком Range
- **AND** проверяет, что реальный контент не является HTML

#### Сценарий: Обнаружение HTML в теле

- **WHEN** тело ответа GET начинается с "<" или содержит "<!DOCTYPE" или "<html"
- **THEN** система помечает URL как невалидный
- **AND** логирует превью тела

#### Сценарий: Проверка размера octet-stream

- **WHEN** Content-Type — "application/octet-stream"
- **AND** Content-Length меньше 100KB
- **THEN** система помечает URL как невалидный
- **AND** логирует ошибку слишком малого размера

#### Сценарий: Предупреждение для URL YouTube

- **WHEN** URL включает "googlevideo.com"
- **AND** валидация успешна
- **THEN** система логирует предупреждение, что URL может истечь
- **AND** помечает URL как валидный

#### Сценарий: Успешная валидация

- **WHEN** URL проходит все проверки валидации
- **THEN** система помечает URL как валидный
- **AND** логирует успех валидации с типом контента и размером

#### Сценарий: Обработка сетевых ошибок

- **WHEN** запрос валидации завершается сетевой ошибкой
- **THEN** система помечает URL как невалидный
- **AND** логирует сетевую ошибку
- **AND** не предполагает, что URL валиден

#### Сценарий: Обработка 206 Partial Content

- **WHEN** GET-запрос с заголовком Range возвращает статус 206
- **THEN** система рассматривает как успех
- **AND** продолжает валидацию

#### Сценарий: Неудача запроса Range

- **WHEN** запрос Range завершается неудачей
- **THEN** система помечает URL как невалидный
- **AND** логирует ошибку неудачи Range

### Требование: Определение прямых URL изображений

Система SHALL корректно определять URL-адреса, указывающие непосредственно на файлы изображений.

#### Сценарий: Обнаружение preview.redd.it

- **WHEN** hostname URL заканчивается на "preview.redd.it"
- **THEN** система определяет как прямой URL изображения

#### Сценарий: Расширение файла изображения

- **WHEN** URL заканчивается на .jpg, .jpeg, .png, .webp или .gif
- **THEN** система определяет как прямой URL изображения

#### Сценарий: Параметр формата

- **WHEN** URL содержит "format=pjpg"
- **THEN** система определяет как прямой URL изображения

#### Сценарий: URL не изображения

- **WHEN** URL не соответствует паттернам изображения
- **THEN** система не определяет как прямое изображение
