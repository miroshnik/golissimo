# Публикация в Telegram

## Purpose

Публиковать медиа-контент (видео, изображения) в канал Telegram с отформатированными сообщениями, включающими заголовки, ссылки на источники, ссылки на плеер и AI-сгенерированные хештеги. Реализовать логику повторов для ненадежных URL и откат на текстовые сообщения при неудаче публикации видео.

## Requirements

### Требование: Публикация изображений в Telegram

Система SHALL публиковать медиа-изображения в канал Telegram, используя API sendPhoto.

#### Сценарий: Публикация изображения

- **WHEN** URL медиа определен как прямое изображение (JPG, PNG, GIF, WebP)
- **THEN** система вызывает API Telegram sendPhoto
- **AND** включает URL изображения, подпись с заголовком и хештегами, режим парсинга HTML
- **AND** использует TELEGRAM_BOT_TOKEN и TELEGRAM_CHAT_ID из окружения

#### Сценарий: Успешная публикация изображения

- **WHEN** API sendPhoto возвращает успех
- **THEN** система помечает ключи поста и медиа как обработанные
- **AND** логирует успех с ключом поста и типом "photo"
- **AND** пропускает обработку видео

#### Сценарий: Неудача публикации изображения

- **WHEN** API sendPhoto возвращает ошибку
- **THEN** система логирует ошибку со статусом и телом ответа
- **AND** удаляет резервации ключей медиа и поста
- **AND** продолжает со следующим постом

### Требование: Публикация видео в Telegram

Система SHALL публиковать медиа-видео в канал Telegram, используя API sendVideo с метаданными.

#### Сценарий: Публикация видео с полным MP4

- **WHEN** URL видео является валидным MP4 из доверенного источника (Reddit, Streamain, YouTube)
- **AND** URL валидирован
- **THEN** система вызывает API Telegram sendVideo
- **AND** включает:
  - URL видео
  - Подпись с заголовком, ссылками и хештегами
  - Режим парсинга HTML
  - supports_streaming: true
  - URL миниатюры (если доступен)
  - Метаданные width, height, duration (если доступны)

#### Сценарий: Успешная публикация видео

- **WHEN** API sendVideo возвращает успех
- **THEN** система помечает ключи поста и медиа как обработанные
- **AND** логирует успех с ключом поста

#### Сценарий: Предупреждение для видео DASH

- **WHEN** видео в формате DASH (без аудио)
- **AND** повторы исчерпаны
- **THEN** система добавляет "⚠️ no audio" к подписи
- **AND** отправляет видео в любом случае при последней попытке

#### Сценарий: Неудача публикации видео

- **WHEN** API sendVideo возвращает ошибку
- **THEN** система логирует ошибку со статусом и телом ответа
- **AND** удаляет резервации ключей медиа и поста
- **AND** позволяет повторить попытку при следующем запуске cron

### Требование: Откат на текстовое сообщение

Система SHALL откатываться на sendMessage, когда URL видео невалиден или ненадежен.

#### Сценарий: Отправка текста при последнем повторе

- **WHEN** URL видео невалиден или ненадежен
- **AND** повторы исчерпаны (retriesLeft <= 1)
- **THEN** система вызывает API Telegram sendMessage
- **AND** включает заголовок со ссылкой на источник (↗) и ссылкой на плеер (▷)
- **AND** включает хештеги, если сгенерированы
- **AND** использует режим парсинга HTML

#### Сценарий: Логирование текстового сообщения

- **WHEN** текстовое сообщение отправлено
- **THEN** система логирует метод как "sendMessage-last"
- **AND** включает причину: "invalid-url", "dash-skipped", "untrusted-source" или "no-mp4"

### Требование: Построение содержимого сообщения

Система SHALL конструировать отформатированное содержимое сообщения для публикаций в Telegram.

#### Сценарий: Сообщение со ссылками

- **WHEN** URL медиа существует
- **THEN** система строит сообщение с:
  - HTML-экранированным заголовком
  - Ссылкой на источник (↗), указывающей на URL медиа
  - Ссылкой на плеер (▷) для видео MP4/M3U8, указывающей на страницу /player
- **AND** добавляет хештеги на новой строке, если сгенерированы

#### Сценарий: Сообщение без ссылок

- **WHEN** URL медиа недоступен
- **THEN** система строит сообщение только с HTML-экранированным заголовком
- **AND** добавляет хештеги на новой строке, если сгенерированы

#### Сценарий: Обработка HTML-сущностей

- **WHEN** заголовок поста содержит HTML-сущности
- **THEN** система декодирует сущности перед экранированием
- **AND** экранирует снова для безопасного HTML-вывода

#### Сценарий: Построение URL плеера

- **WHEN** URL видео — MP4 или M3U8
- **THEN** система конструирует абсолютный URL плеера:
  - Базовый: "https://golissimo.miroshnik.workers.dev"
  - Путь: "/player?video={encoded_url}"
  - Добавляет "&audio={encoded_url}", если URL аудио существует

### Требование: Логика повторов для видео

Система SHALL повторять обработку видео до 5 раз перед откатом на текстовое сообщение.

#### Сценарий: Повтор при невалидном URL

- **WHEN** валидация URL видео не проходит
- **AND** повторы остались > 1
- **THEN** система уменьшает счетчик повторов
- **AND** сохраняет новый счетчик в KV
- **AND** удаляет резервацию ключа медиа
- **AND** пропускает публикацию в этом запуске

#### Сценарий: Повтор для видео DASH

- **WHEN** видео в формате DASH
- **AND** повторы остались > 1
- **THEN** система повторяет при следующем запуске
- **AND** пропускает публикацию в этом запуске

#### Сценарий: Повтор для ненадежного источника

- **WHEN** URL видео из ненадежного источника
- **AND** повторы остались > 1
- **THEN** система повторяет при следующем запуске
- **AND** пропускает публикацию в этом запуске

#### Сценарий: Последняя попытка повтора

- **WHEN** повторы остались <= 1
- **THEN** система предпринимает финальное разрешение
- **AND** отправляет как видео, если разрешено и доверено
- **AND** отправляет как текст, если все еще невалидно или ненадежно

#### Сценарий: Финальная попытка разрешения

- **WHEN** повторы исчерпаны и URL невалиден
- **THEN** система предпринимает разрешение через Puppeteer еще раз
- **AND** пере-валидирует разрешенный URL
- **AND** использует разрешенный URL, если валиден

### Требование: Обработка доверенных источников

Система SHALL приоритезировать доверенные источники видео, которые надежно работают с Telegram.

#### Сценарий: Определение доверенного источника

- **WHEN** URL видео включает "v.redd.it", "reddit.com", "googlevideo.com" или "streamain.com"
- **THEN** система помечает как доверенный источник
- **AND** отправляет видео напрямую без дополнительных задержек валидации

#### Сценарий: Повтор для ненадежного источника

- **WHEN** URL видео из ненадежного источника
- **THEN** система повторяет сначала перед отправкой
- **AND** отправляет только при последней попытке как текстовое сообщение, если все еще ненадежно
