# Видео-плеер

## Purpose

Предоставлять страницу видеоплеера HTML5 с поддержкой HLS.js для просмотра видео, которые не могут быть воспроизведены встроенно в Telegram. Поддерживает прямое воспроизведение MP4 и потоковую передачу HLS с синхронизацией аудио для видео DASH.

## Requirements

### Требование: Страница веб-видеоплеера

Система SHALL предоставлять страницу видеоплеера HTML5 для просмотра видео с поддержкой HLS.

#### Сценарий: Запрос страницы плеера

- **WHEN** GET-запрос к `/player?video={url}&audio={audio_url}`
- **THEN** система возвращает HTML-страницу с видеоплеером
- **AND** устанавливает Content-Type в "text/html; charset=utf-8"

#### Сценарий: Настройка источника видео

- **WHEN** параметр video — URL M3U8
- **THEN** плеер использует библиотеку HLS.js для совместимости с Chrome
- **AND** настраивает HLS с lowLatencyMode: true, backBufferLength: 60
- **AND** пытается нативное воспроизведение HLS для устройств Safari/Apple
- **AND** откатывается на прямое назначение src

#### Сценарий: Воспроизведение видео MP4

- **WHEN** параметр video — URL MP4
- **THEN** плеер устанавливает video.src напрямую на URL
- **AND** включает автозапуск с приглушенным аудио

#### Сценарий: Синхронизация аудиодорожки

- **WHEN** параметр audio предоставлен
- **THEN** плеер создает скрытый аудио-элемент
- **AND** синхронизирует воспроизведение аудио с видео:
  - Синхронизация play/pause
  - Синхронизация поиска
  - Синхронизация скорости воспроизведения

#### Сценарий: Обработка автозапуска

- **WHEN** страница загружается
- **THEN** плеер пытается автозапуск для видео и аудио
- **AND** оба приглушены для удовлетворения политик автозапуска браузера
- **AND** перехватывает и игнорирует ошибки автозапуска

#### Сценарий: Стилизация плеера

- **WHEN** страница плеера рендерится
- **THEN** видео-элемент заполняет viewport с:
  - Фиксированным позиционированием, покрывающим весь viewport
  - Object-fit: contain
  - Черным фоном
  - Полной шириной и высотой

#### Сценарий: Парсинг манифеста HLS

- **WHEN** HLS.js успешно загружает манифест
- **THEN** плеер запускает автозапуск
- **AND** видео начинает воспроизводиться автоматически

#### Сценарий: Параметр audio отсутствует

- **WHEN** параметр audio не предоставлен
- **THEN** аудио-элемент скрыт с display:none
- **AND** играет только видео

#### Сценарий: Кодирование URL

- **WHEN** URL видео или аудио содержат специальные символы
- **THEN** система правильно кодирует URL в query-параметрах
- **AND** плеер корректно декодирует URL

#### Сценарий: Ссылка на плеер в Telegram

- **WHEN** видео в формате MP4 или M3U8
- **THEN** сообщение Telegram включает ссылку на плеер (▷)
- **AND** ссылка указывает на абсолютный URL: https://golissimo.miroshnik.workers.dev/player?video={url}

### Требование: Структура HTML

Система SHALL возвращать валидный документ HTML5 с необходимыми скриптами и стилями.

#### Сценарий: Структура HTML-документа

- **WHEN** запрашивается страница плеера
- **THEN** HTML включает:
  - DOCTYPE html5
  - Мета-тег charset UTF-8
  - Мета-тег viewport
  - Встроенный CSS для полноэкранного видео
  - Элементы video и audio
  - Скрипт HLS.js из CDN
  - Встроенный JavaScript для логики плеера

#### Сценарий: Загрузка скрипта из CDN

- **WHEN** страница плеера загружается
- **THEN** HLS.js загружается с https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js
- **AND** скрипт выполняется перед инициализацией плеера

#### Сценарий: Атрибут Crossorigin

- **WHEN** видео-элемент создан
- **THEN** устанавливается crossorigin="anonymous"
- **AND** разрешает CORS для видеоресурсов
